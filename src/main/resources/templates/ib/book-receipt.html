<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ì…ê³  ì£¼ë¬¸ ë“±ë¡</title>

  <!-- ê³µí†µ CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background-color: #f8f9fa;
      font-family: 'Noto Sans KR', sans-serif;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100vh;
      background-color: #343a40;
    }

    .main-content {
      margin-left: 260px;
      padding: 2rem;
    }

    #receiptGrid {
      background-color: white;
    }
  </style>
</head>

<body>

<!-- ì‚¬ì´ë“œë°” í¬í•¨ -->
<div th:replace="fragments/sidebar :: sidebar"></div>

<!-- âœ… ë³¸ë¬¸ ì½˜í…ì¸  -->
<div class="main-content">
  <h4 class="mb-4">ğŸ“¦ ì…ê³  ì£¼ë¬¸ ë“±ë¡</h4>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#bookSearchModal">+ ë„ì„œ ì¶”ê°€</button>
    <button class="btn btn-primary" onclick="submitReceipt()">ì…ê³  ë“±ë¡</button>
  </div>

  <div id="receiptGrid"></div>

  <div class="row mt-4">
    <div class="col-md-4">
      <label>ì…ê³ ì¼ì</label>
      <input type="date" id="receiptDate" class="form-control" value="2025-07-30">
    </div>
    <div class="col-md-4">
      <label>ì…ê³  ë‹´ë‹¹ì</label>
      <input type="text" id="receiptBy" class="form-control" value="ê´€ë¦¬ì">
    </div>
  </div>
</div>

<!-- ëª¨ë‹¬ -->
<div class="modal fade" id="bookSearchModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ë„ì„œ ê²€ìƒ‰</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <table class="table table-hover text-center align-middle">
          <thead class="table-light">
          <tr>
            <th>ì´ë¯¸ì§€</th>
            <th>ë„ì„œëª…</th>
            <th>ì €ì</th>
            <th>ì¶œíŒì‚¬</th>
          </tr>
          </thead>
          <tbody id="bookSearchTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

<script>
  const table = new Tabulator("#receiptGrid", {
    height: "400px",
    layout: "fitColumns",
    data: [],
    columns: [
      { title: "ë„ì„œ ì´ë¯¸ì§€", field: "cover", formatter: "image", width: 100, hozAlign: "center" },
      { title: "ë„ì„œëª…", field: "title", editor: "input" },
      { title: "ìˆ˜ëŸ‰", field: "qty", editor: "number", validator: ["required", "min:1"], hozAlign: "center", width: 100 },
      {
        title: "ì‚­ì œ", formatter: "buttonCross", width: 60, hozAlign: "center",
        cellClick: (e, cell) => cell.getRow().delete()
      }
    ]
  });

  function submitReceipt() {
    const rows = table.getData();
    if (rows.length === 0) {
      alert("ì…ê³ í•  ë„ì„œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”!");
      return;
    }

    fetch("/ib/receipt", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        books: rows,
        receiptDate: document.querySelector("#receiptDate").value,
        receiptBy: document.querySelector("#receiptBy").value
      })
    }).then(res => {
      if (res.ok) {
        alert("ì…ê³  ë“±ë¡ ì™„ë£Œ!");
        window.location.href = "/ib/receipt";
      } else {
        alert("ì˜¤ë¥˜ ë°œìƒ");
      }
    });
  }
</script>
</body>
</html>
